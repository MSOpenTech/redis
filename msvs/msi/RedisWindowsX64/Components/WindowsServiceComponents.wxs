<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:util="http://schemas.microsoft.com/wix/UtilExtension"
     xmlns:fw="http://schemas.microsoft.com/wix/FirewallExtension">
	<Fragment>
    <!--This references a WiX property that gives us the localized name of the NETWORK SERVICE user-->
    <PropertyRef Id="WIX_ACCOUNT_NETWORKSERVICE" />
    
    <ComponentGroup Id="WindowsServiceComponents" Directory="INSTALLFOLDER">
      <!--
        The following component installs Redis as a Windows service.
      -->
      <Component Id="cmp_redis_server" Guid="{959AF3FA-9324-49CB-8915-0563398CDDF6}">
        <File Id="file_redis_serverEXE" Source="$(var.RedisServer.TargetDir)redis-server.exe" KeyPath="yes" />
        <File Id="file_redis_windowsCONF" Source="!(wix.DocumentationFolder)\redis.windows.conf" />
        
        <ServiceInstall Id="redisService" 
                        Name="Redis"
                        DisplayName="Redis" 
                        Description="This service runs the Redis server" 
                        Start="auto" 
                        ErrorControl="normal" 
                        Type="ownProcess" 
                        Arguments="--service-run &quot;[#file_redis_windowsCONF]&quot;" 
                        Account="[WIX_ACCOUNT_NETWORKSERVICE]" />
        
        <ServiceControl Id="redisServiceControl" 
                        Name="Redis" 
                        Start="install" 
                        Stop="both" 
                        Remove="uninstall" 
                        Wait="yes" />
      </Component>

      <!--
        The following component creates the firewall exception.
      -->
      <Component Id="cmp_firewall_exception" Guid="{1D39F01C-6C53-4DC1-B189-65F03F7E5E31}" KeyPath="yes">
        <Condition><![CDATA[FIREWALL_ON = 1]]></Condition>
        
        <fw:FirewallException Id="fw_redis_server"
                              Program="[#file_redis_serverEXE]"
                              Description="Exception for Redis server"
                              Name="Redis" 
                              Scope="any" />
      </Component>

      <!--
          The following component gives the NetworkService user full access to the Redis install directory.
          It needs this to start the service.
      -->
      <Component Id="cmp_give_network_service_folder_permissions" Guid="{55E5EFB3-61E6-4D51-934E-BFEEFB430701}">
        <CreateFolder>
          <util:PermissionEx User="[WIX_ACCOUNT_NETWORKSERVICE]" GenericAll="yes" />
        </CreateFolder>
      </Component>
    </ComponentGroup>
	</Fragment>
</Wix>